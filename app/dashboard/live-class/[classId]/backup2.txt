//marked
"use client";
import Cookies from "js-cookie";
import Link from "next/link";
import Image from "next/image";
import { useParams, useRouter } from "next/navigation";
import { useEffect, useRef, useState, useCallback } from "react";
import {
  FaArrowLeft,
  FaChalkboardTeacher,
  FaComments,
  FaTimes,
  FaUserCircle,
  FaPlay,
  FaPause,
  FaVolumeUp,
  FaVolumeMute,
  FaExpand,
  FaCompress,
  FaForward,
} from "react-icons/fa";
import io from "socket.io-client";
import dynamic from "next/dynamic";

// Dynamically import ReactPlayer
const ReactPlayer = dynamic(() => import("react-player/youtube"), { ssr: false });

// Socket.io initialization
const socket = io(`${process.env.NEXT_PUBLIC_SERVER_URL}`, {
  transports: ["websocket", "polling"],
  withCredentials: true,
  auth: {
    token: Cookies.get("accessToken"),
  },
  reconnection: true,
  reconnectionAttempts: 5,
  reconnectionDelay: 1000,
});

// Socket error handling
socket.on("connect_error", (err) => {
  console.error("Socket connection error:", err.message);
});
socket.on("connect_timeout", (timeout) => {
  console.error("Socket connection timeout:", timeout);
});
socket.on("error", (err) => {
  console.error("Socket error:", err);
});

const LiveClassPage = () => {
  const params = useParams();
  const classId = params?.classId;
  const router = useRouter();
  const [classData, setClassData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState("");
  const [showChat, setShowChat] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [playerError, setPlayerError] = useState(null);
  const messagesEndRef = useRef(null);
  const playerContainerRef = useRef(null);
  const speedButtonRef = useRef(null);
  const [tooltipTime, setTooltipTime] = useState("");
  const [showTooltip, setShowTooltip] = useState(false);
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });

  // ReactPlayer states
  const [playing, setPlaying] = useState(false);
  const [volume, setVolume] = useState(0.8);
  const [muted, setMuted] = useState(false);
  const [played, setPlayed] = useState(1);
  const [duration, setDuration] = useState(0);
  const [isLive, setIsLive] = useState(true);
  const [hasWindow, setHasWindow] = useState(false);
  const [isAtLiveEdge, setIsAtLiveEdge] = useState(true);
  const [isFullScreen, setIsFullScreen] = useState(false);
  const [playbackRate, setPlaybackRate] = useState(1);
  const [showSpeedDropdown, setShowSpeedDropdown] = useState(false);
  const [showVolumeSlider, setShowVolumeSlider] = useState(false);
  const [showOverlay, setShowOverlay] = useState(false);
  const playerRef = useRef(null);

  // Default avatar URL
  const defaultAvatar =
    "https://res.cloudinary.com/dqj0xg3zv/image/upload/v1698231234/avatars/default-avatar.png";

  // Check for window object
  useEffect(() => {
    if (typeof window !== "undefined") {
      setHasWindow(true);
    }
  }, []);

  // Fetch current student data
  useEffect(() => {
    const fetchCurrentStudent = async () => {
      try {
        const response = await fetch(
          `${process.env.NEXT_PUBLIC_SERVER_URL}/api/student/current-student`,
          { credentials: "include" }
        );
        const data = await response.json();
        if (data.success && data.data.student) {
          setCurrentUser(data.data.student);
        } else {
          setError("Failed to fetch user data");
        }
      } catch (err) {
        setError("Error fetching user data");
        console.error(err);
      }
    };
    fetchCurrentStudent();
  }, []);

  // Fetch class data
  useEffect(() => {
    const fetchClassData = async () => {
      if (!process.env.NEXT_PUBLIC_SERVER_URL) {
        setError("Server URL is not configured.");
        setLoading(false);
        return;
      }
      try {
        const response = await fetch(
          `${process.env.NEXT_PUBLIC_SERVER_URL}/api/student/class/${classId}`,
          { credentials: "include" }
        );
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || "Failed to fetch class data");
        }
        setClassData(data);
      } catch (err) {
        setError(err.message || "An unexpected error occurred.");
      } finally {
        setLoading(false);
      }
    };
    if (classId) {
      fetchClassData();
    }
  }, [classId]);

  // Chat Socket.IO logic
  useEffect(() => {
    if (!classId) return;
    socket.emit("join class", classId);
    socket.on("load messages", (loadedMessages) => {
      setMessages(loadedMessages);
    });
    socket.on("receive message", (message) => {
      setMessages((prev) => [...prev, message]);
    });
    socket.on("error", (errorMessage) => {
      console.error("Socket.IO error:", errorMessage);
      setError(errorMessage);
    });
    return () => {
      socket.off("load messages");
      socket.off("receive message");
      socket.off("error");
    };
  }, [classId]);

  // Scroll to bottom of message list
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // ReactPlayer live edge check
  useEffect(() => {
    if (isLive && playerRef.current) {
      const interval = setInterval(() => {
        const currentTime = playerRef.current.getCurrentTime();
        const duration = playerRef.current.getDuration() || Infinity;
        const isLiveEdge = isLive ? currentTime >= duration - 10 : false;
        setIsAtLiveEdge(isLiveEdge);
        if (isLiveEdge) {
          setPlayed(1);
        }
      }, 1000);
      return () => clearInterval(interval);
    }
  }, [isLive]);

  // Full-screen state tracking
  useEffect(() => {
    const handleFullScreenChange = () => {
      setIsFullScreen(!!document.fullscreenElement);
    };
    document.addEventListener("fullscreenchange", handleFullScreenChange);
    return () => {
      document.removeEventListener("fullscreenchange", handleFullScreenChange);
    };
  }, []);

  // Close speed dropdown on outside click
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (
        speedButtonRef.current &&
        !speedButtonRef.current.contains(event.target)
      ) {
        setShowSpeedDropdown(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, []);

  const sendMessage = useCallback(() => {
    if (input.trim() && classId) {
      socket.emit("send message", { content: input, classId });
      setInput("");
    }
  }, [input, classId]);

  const handleKeyPress = useCallback(
    (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    },
    [sendMessage]
  );

  const handleProgress = useCallback(
    (state) => {
      if (!state.seeking && !isAtLiveEdge) {
        setPlayed(state.played);
      }
    },
    [isAtLiveEdge]
  );

  const handleDuration = useCallback((duration) => {
    setDuration(duration);
    setIsLive(true);
  }, []);

  const formatTime = useCallback((seconds) => {
    const date = new Date(seconds * 1000);
    const hh = date.getUTCHours();
    const mm = date.getUTCMinutes().toString().padStart(2, "0");
    const ss = date.getUTCSeconds().toString().padStart(2, "0");
    return hh > 0 ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
  }, []);

  const jumpToLive = useCallback(() => {
    if (playerRef.current) {
      playerRef.current.seekTo(1e10);
      setPlayed(1);
      setIsAtLiveEdge(true);
      if (!playing) {
        setPlaying(true);
      }
    }
  }, [playing]);

  const handlePlayPause = useCallback(() => {
    setPlaying((prev) => !prev);
    setShowOverlay(true);
    setTimeout(() => setShowOverlay(false), 1000);
  }, []);

  const handleVolumeChange = useCallback((e) => {
    const newVolume = parseFloat(e.target.value);
    setVolume(newVolume);
    setMuted(newVolume === 0);
  }, []);

  const toggleMute = useCallback(() => {
    setMuted((prev) => !prev);
    setVolume((prev) => (prev === 0 ? 0.8 : 0));
  }, []);

  const handleSeekChange = useCallback((e) => {
    const newPlayed = parseFloat(e.target.value);
    setPlayed(newPlayed);
    setIsAtLiveEdge(newPlayed > 0.99);
  }, []);

  const handleSeekEnd = useCallback(
    (e) => {
      if (playerRef.current) {
        const seekTo = parseFloat(e.target.value);
        playerRef.current.seekTo(seekTo * duration);
        setIsAtLiveEdge(seekTo > 0.99);
      }
    },
    [duration]
  );

  const handleSeekHover = useCallback(
    (e) => {
      const rect = e.target.getBoundingClientRect();
      const position = (e.clientX - rect.left) / rect.width;
      const time = position * duration;
      setTooltipTime(formatTime(time));
      setTooltipPosition({
        x: e.clientX - rect.left,
        y: rect.top - 30,
      });
      setShowTooltip(true);
    },
    [duration, formatTime]
  );

  const handleSeekHoverEnd = useCallback(() => {
    setShowTooltip(false);
  }, []);

  const changeSpeed = useCallback((speed) => {
    setPlaybackRate(speed);
    if (playerRef.current) {
      playerRef.current.getInternalPlayer().setPlaybackRate(speed);
    }
    setShowSpeedDropdown(false);
  }, []);

  const toggleFullScreen = useCallback(() => {
    if (!playerContainerRef.current) return;
    if (!document.fullscreenElement) {
      playerContainerRef.current.requestFullscreen().catch((err) => {
        console.error(`Error enabling fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }, []);

  const handlePlayerError = useCallback((err) => {
    console.error("Player error:", err);
    setPlayerError("Failed to load the live stream. Please try again.");
  }, []);

  if (loading) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh]">
        <p className="text-lg text-gray-600">Loading class data...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh] text-red-500">
        <p className="text-lg font-medium mb-2">Error loading class</p>
        <p className="text-sm">{error}</p>
        <Link href="/dashboard/live-class">
          <button className="mt-4 bg-[#f7374f] text-white px-4 py-2 rounded-lg hover:bg-[#e12d42] transition-colors flex items-center gap-2">
            <FaArrowLeft /> Back to Live Classes
          </button>
        </Link>
      </div>
    );
  }

  if (!classData || !classData.data || !classData.data.data) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh]">
        <p className="text-lg">Class not found</p>
        <button
          onClick={() => router.back()}
          className="mt-4 bg-[#f7374f] text-white px-4 py-2 rounded-lg hover:bg-[#e12d42] transition-colors flex items-center gap-2"
        >
          <FaArrowLeft /> Back to Live Classes
        </button>
      </div>
    );
  }

  if (!classData.data.data.isActiveLive) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh]">
        <p className="text-lg">Live class ended</p>
        <button
          onClick={() => router.back()}
          className="mt-4 bg-[#f7374f] text-white px-4 py-2 rounded-lg hover:bg-[#e12d42] transition-colors flex items-center gap-2"
        >
          <FaArrowLeft /> Back to Live Classes
        </button>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-2 md:px-4 py-4 lg:py-6">
      <style jsx global>{`
        /* Remove pointer-events: none to allow interaction with player */
        .react-player iframe,
        .react-player__player {
          pointer-events: auto !important;
        }
        /* Hide YouTube native controls */
        .react-player__html5-player,
        .ytp-chrome-top,
        .ytp-chrome-bottom,
        .ytp-gradient-top,
        .ytp-gradient-bottom,
        .ytp-button:not(.ytp-play-button),
        .ytp-cards-teaser,
        .ytp-card,
        .ytp-ce-element,
        .ytp-pause-overlay,
        .ytp-watermark,
        .ytp-share-button,
        .ytp-watch-later-button,
        .ytp-info-button,
        .ytp-related-videos,
        .ytp-endcard,
        .ytp-show-cards-title,
        .ytp-title,
        .ytp-title-text,
        .ytp-title-channel,
        .ytp-autonav-endscreen,
        .ytp-endscreen-content,
        .ytp-suggestions,
        .ytp-upnext,
        .ytp-upnext-card,
        .ytp-upnext-overlay,
        .ytp-cued-thumbnail-overlay,
        .ytp-large-play-button,
        .ytp-spinner,
        .ytp-error,
        .ytp-impression-link {
          display: none !important;
          visibility: hidden !important;
          pointer-events: none !important;
        }
        .chat-modal {
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 80%;
          transform: translateY(100%);
          transition: transform 0.3s ease;
        }
        .chat-modal.open {
          transform: translateY(0);
        }
        @media (min-width: 640px) {
          .chat-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 24rem;
            height: 100%;
            transform: translateX(100%);
          }
          .chat-modal.open {
            transform: translateX(0);
          }
        }
        .react-player-container {
          position: relative;
          width: 100%;
          max-width: 896px;
          margin: 0 auto;
          border-radius: 8px;
          overflow: hidden;
          background: #000;
        }
        .player-overlay {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: calc(100% - 60px);
          background: rgba(0, 0, 0, 0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10;
          pointer-events: ${showOverlay || !playing ? "auto" : "none"};
          opacity: ${showOverlay || !playing ? 1 : 0};
          transition: opacity 0.3s ease;
        }
        .player-overlay:hover {
          opacity: 1;
          pointer-events: auto;
        }
        .player-overlay button {
          background: rgba(0, 0, 0, 0.7);
          border-radius: 50%;
          padding: 15px;
          border: none;
          cursor: pointer;
          transition: transform 0.2s ease;
          pointer-events: auto;
        }
        .player-overlay button:hover {
          transform: scale(1.1);
        }
        .react-player-controls {
          background: #1f2937;
          padding: 12px;
          border-radius: 0 0 8px 8px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 8px;
          position: relative;
          z-index: 20;
        }
        @media (max-width: 640px) {
          .react-player-controls {
            flex-direction: column;
            align-items: stretch;
          }
          .react-player-controls > div {
            margin: 4px 0;
          }
        }
        .control-button {
          background: #374151;
          color: white;
          padding: 8px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: background 0.2s ease;
        }
        .control-button:hover {
          background: #4b5563;
        }
        .control-button:disabled {
          background: #6b7280;
          cursor: not-allowed;
        }
        .range-slider {
          height: 8px;
          background: #4b5563;
          border-radius: 4px;
          appearance: none;
          outline: none;
          cursor: pointer;
          touch-action: none;
          width: 100%;
          position: relative;
        }
        .range-slider:disabled {
          cursor: not-allowed;
          opacity: 0.5;
        }
        .range-slider::-webkit-slider-thumb {
          appearance: none;
          width: 16px;
          height: 16px;
          background: #f7374f;
          border-radius: 50%;
          cursor: pointer;
          border: 2px solid #fff;
          box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
          position: relative;
          top: -4px;
        }
        .range-slider::-moz-range-thumb {
          width: 16px;
          height: 16px;
          background: #f7374f;
          border-radius: 50%;
          cursor: pointer;
          border: 2px solid #fff;
          box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }
        .range-slider::-webkit-slider-runnable-track {
          background: linear-gradient(
            to right,
            #f7374f 0%,
            #f7374f ${(played * 100)}%,
            #4b5563 ${(played * 100)}%,
            #4b5563 100%
          );
          height: 8px;
          border-radius: 4px;
        }
        .range-slider::-moz-range-progress {
          background: #f7374f;
          height: 8px;
          border-radius: 4px;
        }
        .range-slider::-moz-range-track {
          background: #4b5563;
          height: 8px;
          border-radius: 4px;
        }
        .volume-container {
          position: relative;
          display: flex;
          align-items: center;
        }
        .volume-slider {
          position: absolute;
          bottom: 40px;
          left: 50%;
          transform: translateX(-50%);
          width: 4px;
          height: 100px;
          background: #4b5563;
          border-radius: 2px;
          appearance: none;
          outline: none;
          cursor: pointer;
          writing-mode: bt-lr;
          -webkit-appearance: slider-vertical;
        }
        .volume-slider::-webkit-slider-thumb {
          appearance: none;
          width: 10px;
          height: 10px;
          background: #f7374f;
          border-radius: 50%;
          cursor: pointer;
        }
        .volume-slider::-moz-range-thumb {
          width: 10px;
          height: 10px;
          background: #f7374f;
          border-radius: 50%;
          cursor: pointer;
        }
        .volume-slider::-webkit-slider-runnable-track {
          background: linear-gradient(
            to top,
            #f7374f 0%,
            #f7374f ${(volume * 100)}%,
            #4b5563 ${(volume * 100)}%,
            #4b5563 100%
          );
        }
        .volume-slider::-moz-range-progress {
          background: #f7374f;
        }
        .speed-dropdown {
          position: absolute;
          bottom: 100%;
          right: 0;
          background: #1f2937;
          border-radius: 4px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
          z-index: 20;
          padding: 8px 0;
        }
        .speed-dropdown button {
          display: block;
          width: 100%;
          padding: 8px 16px;
          text-align: left;
          color: white;
          background: none;
          border: none;
          cursor: pointer;
        }
        .speed-dropdown button:hover {
          background: #374151;
        }
        .live-status {
          position: absolute;
          top: 10px;
          left: 10px;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          display: flex;
          align-items: center;
          gap: 4px;
          z-index: 15;
        }
        .live-dot {
          width: 8px;
          height: 8px;
          background: #f7374f;
          border-radius: 50%;
          animation: pulse 1.5s infinite;
        }
        .timeline-tooltip {
          position: absolute;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          transform: translateX(-50%);
          z-index: 30;
          pointer-events: none;
        }
        @keyframes pulse {
          0% {
            opacity: 1;
          }
          50% {
            opacity: 0.5;
          }
          100% {
            opacity: 1;
          }
        }
      `}</style>
      <div className="bg-white rounded-xl shadow-md overflow-hidden mb-8 border border-gray-100">
        <div className="bg-[#f7374f] p-4 text-white">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div className="flex items-center gap-3">
              <FaChalkboardTeacher className="text-2xl" />
              <h1 className="text-xl md:text-2xl font-bold">
                {classData.data.data?.title || "Live Class"}
              </h1>
            </div>
            <Link
              href="/student-dashboard/live-classes"
              className="bg-white/20 px-3 py-1 rounded-full їtext-sm hover:bg-white/30 transition-colors flex items-center gap-1"
            >
              <FaArrowLeft /> All Classes
            </Link>
          </div>
        </div>

        <div className="p-4">
          <div className="mb-6">
            {classData.data.data.videoLink ? (
              playerError ? (
                <div className="bg-gray-100 rounded-lg aspect-video flex items-center justify-center text-red-500">
                  {playerError}
                </div>
              ) : (
                <div
                  className="react-player-container"
                  ref={playerContainerRef}
                  onMouseEnter={() => setShowOverlay(true)}
                  onMouseLeave={() => playing && setShowOverlay(false)}
                >
                  {isLive && (
                    <div className="live-status">
                      <span className="live-dot"></span>
                      LIVE
                    </div>
                  )}
                  {hasWindow && (
                    <ReactPlayer
                      ref={playerRef}
                      url={classData.data.data.videoLink}
                      playing={playing}
                      volume={muted ? 0 : volume}
                      playbackRate={playbackRate}
                      width="100%"
                      height="auto"
                      className="react-player"
                      style={{ aspectRatio: "16/9" }}
                      onProgress={handleProgress}
                      onDuration={handleDuration}
                      onError={handlePlayerError}
                      config={{
                        youtube: {
                          playerVars: {
                            controls: 0,
                            disablekb: 1,
                            modestbranding: 1,
                            rel: 0,
                            enablejsapi: 1,
                            iv_load_policy: 3,
                            start: 0,
                            autoplay: 0,
                          },
                        },
                      }}
                    />
                  )}
                  <div className="player-overlay">
                    <button
                      onClick={handlePlayPause}
                      aria-label={playing ? "Pause" : "Play"}
                      role="button"
                      tabIndex={0}
                    >
                      {playing ? (
                        <FaPause size={40} color="white" />
                      ) : (
                        <FaPlay size={40} color="white" />
                      )}
                    </button>
                  </div>
                  <div className="react-player-controls">
                    <div className="flex items-center gap-2">
                      <button
                        onClick={handlePlayPause}
                        className="control-button"
                        aria-label={playing ? "Pause" : "Play"}
                        role="button"
                        tabIndex={0}
                      >
                        {playing ? <FaPause size={16} /> : <FaPlay size={16} />}
                      </button>
                      <button
                        onClick={() => {
                          if (playerRef.current) {
                            const current = playerRef.current.getCurrentTime();
                            playerRef.current.seekTo(current - 10);
                            setIsAtLiveEdge(false);
                          }
                        }}
                        className="control-button"
                        aria-label="Rewind 10 seconds"
                        disabled={isLive && isAtLiveEdge}
                        role="button"
                        tabIndex={0}
                      >
                        <FaForward
                          size={16}
                          style={{ transform: "rotate(180deg)" }}
                        />
                      </button>
                      <button
                        onClick={() => {
                          if (playerRef.current) {
                            const current = playerRef.current.getCurrentTime();
                            playerRef.current.seekTo(current + 10);
                            setIsAtLiveEdge(false);
                          }
                        }}
                        className="control-button"
                        aria-label="Forward 10 seconds"
                        disabled={isLive && isAtLiveEdge}
                        role="button"
                        tabIndex={0}
                      >
                        <FaForward size={16} />
                      </button>
                    </div>
                    <div className="flex items-center flex-1 mx-4 relative">
                      <span className="text-white text-sm w-16">
                        {formatTime(duration * played)}
                      </span>
                      <input
                        type="range"
                        min={0}
                        max={1}
                        step="any"
                        value={played}
                        onChange={handleSeekChange}
                        onMouseUp={handleSeekEnd}
                        onTouchEnd={handleSeekEnd}
                        onMouseMove={handleSeekHover}
                        onMouseLeave={handleSeekHoverEnd}
                        className="range-slider flex-1"
                        aria-label="Seek video"
                        disabled={false}
                      />
                      {showTooltip && (
                        <div
                          className="timeline-tooltip"
                          style={{
                            left: `${tooltipPosition.x}px`,
                            top: `${tooltipPosition.y}px`,
                          }}
                        >
                          {tooltipTime}
                        </div>
                      )}
                      {isLive && !isAtLiveEdge && (
                        <button
                          onClick={jumpToLive}
                          className="control-button bg-red-500 hover:bg-red-600 ml-2"
                          aria-label="Go Live"
                          role="button"
                          tabIndex={0}
                        >
                          Go Live
                        </button>
                      )}
                    </div>
                    <div className="flex items-center gap-2">
                      <div
                        className="volume-container"
                        onMouseEnter={() => setShowVolumeSlider(true)}
                        onMouseLeave={() => setShowVolumeSlider(false)}
                      >
                        <button
                          onClick={toggleMute}
                          className="control-button"
                          aria-label={muted ? "Unmute" : "Mute"}
                          role="button"
                          tabIndex={0}
                        >
                          {muted || volume === 0 ? (
                            <FaVolumeMute size={16} />
                          ) : (
                            <FaVolumeUp size={16} />
                          )}
                        </button>
                        {showVolumeSlider && (
                          <input
                            type="range"
                            className="volume-slider"
                            min={0}
                            max={1}
                            step="any"
                            value={muted ? 0 : volume}
                            onChange={handleVolumeChange}
                            aria-label="Volume control"
                          />
                        )}
                      </div>
                      {!isLive && (
                        <div className="relative">
                          <button
                            ref={speedButtonRef}
                            onClick={() =>
                              setShowSpeedDropdown(!showSpeedDropdown)
                            }
                            className="control-button text-xs px-3"
                            aria-label="Playback speed"
                            role="button"
                            tabIndex={0}
                          >
                            {playbackRate}x
                          </button>
                          {showSpeedDropdown && (
                            <div className="speed-dropdown">
                              {[0.5, 1, 1.5, 2].map((speed) => (
                                <button
                                  key={speed}
                                  onClick={() => changeSpeed(speed)}
                                  className={`text-xs ${
                                    playbackRate === speed ? "bg-[#f7374f]" : ""
                                  }`}
                                  role="menuitem"
                                  tabIndex={0}
                                >
                                  {speed}x
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      )}
                      <button
                        onClick={toggleFullScreen}
                        className="control-button"
                        aria-label={
                          isFullScreen ? "Exit fullscreen" : "Fullscreen"
                        }
                        role="button"
                        tabIndex={0}
                      >
                        {isFullScreen ? (
                          <FaCompress size={16} />
                        ) : (
                          <FaExpand size={16} />
                        )}
                      </button>
                    </div>
                  </div>
                </div>
              )
            ) : (
              <div className="bg-gray-100 rounded-lg aspect-video flex items-center justify-center text-gray-500">
                No video available for this class
              </div>
            )}
            <div className="flex justify-center mt-4">
              <button
                onClick={() => setShowChat(!showChat)}
                className="bg-[#f7374f] text-white px-4 py-2 rounded-lg hover:bg-[#e12d42] transition-colors flex items-center gap-2"
                aria-label="Toggle live chat"
                role="button"
                tabIndex={0}
              >
                <FaComments size={16} />
                Live Chat
              </button>
            </div>
            {showChat && (
              <div
                className={`chat-modal bg-white shadow-xl z-50 p-6 overflow-y-auto ${
                  showChat ? "open" : ""
                }`}
              >
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold text-gray-800 flex items-center">
                    <span className="mr-2">📢</span> Live Chat
                  </h3>
                  <button
                    onClick={() => setShowChat(false)}
                    className="text-gray-600 hover:text-[#f7374f] transition-colors"
                    aria-label="Close chat"
                    role="button"
                    tabIndex={0}
                  >
                    <FaTimes size={20} />
                  </button>
                </div>
                <div className="flex flex-col h-[calc(100%-4rem)]">
                  <div className="flex-1 overflow-y-auto p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-3">
                    {messages.map((msg) => (
                      <div
                        key={msg._id}
                        className={`flex flex-col p-3 rounded-lg max-w-[85%] ${
                          msg.createdBy._id === currentUser?._id
                            ? "ml-auto bg-[#f7374f] text-white"
                            : "bg-gray-100 text-gray-800"
                        }`}
                      >
                        <div className="flex items-center mb-1">
                          {msg.createdBy.photoUrl ? (
                            <Image
                              src={msg.createdBy.photoUrl}
                              alt={`${msg.createdBy.fullName}'s avatar`}
                              className="w-6 h-6 rounded-full mr-2 object-cover"
                              width={24}
                              height={24}
                              onError={(e) => {
                                e.target.src = defaultAvatar;
                              }}
                            />
                          ) : (
                            <FaUserCircle
                              size={24}
                              className="text-gray-500 mr-2"
                            />
                          )}
                          <div className="flex-1 flex items-center justify-between">
                            <span className="font-medium text-sm">
                              {msg.createdBy.fullName}
                            </span>
                            <span className="text-xs opacity-75">
                              {new Date(msg.createdAt).toLocaleTimeString([], {
                                hour: "2-digit",
                                minute: "2-digit",
                              })}
                            </span>
                          </div>
                        </div>
                        <p className="text-sm">{msg.content}</p>
                      </div>
                    ))}
                    <div ref={messagesEndRef} />
                  </div>
                  <div className="flex gap-3 mt-4">
                    <input
                      type="text"
                      value={input}
                      onChange={(e) => setInput(e.target.value)}
                      onKeyPress={handleKeyPress}
                      placeholder="Type your message..."
                      className="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#f7374f] text-sm"
                      aria-label="Chat input"
                    />
                    <button
                      onClick={sendMessage}
                      className="px-4 py-3 bg-[#f7374f] text-white rounded-lg hover:bg-[#e12d42] transition-colors font-medium text-sm"
                      disabled={!input.trim()}
                      aria-label="Send message"
                      role="button"
                      tabIndex={0}
                    >
                      Send
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="md:col-span-2">
              <h2 className="text-xl font-bold text-gray-800 mb-2">
                About This Class
              </h2>
              <div className="space-y-4">
                <p>
                  <span className="font-medium">Subject:</span>{" "}
                  {classData.data.data.subject
                    ? classData.data.data.subject.charAt(0).toUpperCase() +
                      classData.data.data.subject.slice(1)
                    : "N/A"}
                </p>
                <p>
                  <span className="font-medium">Instructor:</span>{" "}
                  {classData.data.data.instructor || "N/A"}
                </p>
                <p>
                  <span className="font-medium">Course:</span>{" "}
                  {classData.data.data.course?.title || "N/A"}
                </p>
              </div>
            </div>

            <div className="space-y-6">
              <div className="bg-[#f7374f]/5 p-4 rounded-lg border border-[#f7374f]/10">
                <h3 className="font-medium text-gray-800 mb-3 flex items-center">
                  <span className="bg-[#f7374f]/10 p-2 rounded-lg text-[#f7374f] mr-3">
                    <FaChalkboardTeacher />
                  </span>
                  Class Information
                </h3>
                <p className="text-gray-600 text-sm mb-3">
                  This live class is part of your enrolled course. Use the custom
                  controls below the video to manage playback and access the live
                  chat.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default LiveClassPage;